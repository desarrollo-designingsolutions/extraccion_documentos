{% extends "base.html" %}

{% block title %}DS Salud IA - Chat con Documentos{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para NotebookLM */
    .sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        height: calc(100vh - 80px);
        overflow-y: auto;
    }
    
    .chat-container {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 0.75rem;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #e0e7ff;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }
    
    .assistant-message {
        background-color: white;
        border: 1px solid #e2e8f0;
        margin-right: auto;
        border-bottom-left-radius: 0.25rem;
    }
    
    .message-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #4f46e5;
    }
    
    .assistant-message .message-header {
        color: #059669;
    }
    
    .file-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        backdrop-filter: blur(10px);
    }
    
    .conversation-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .conversation-item:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .conversation-item.active {
        background: rgba(255, 255, 255, 0.25);
        border-left: 4px solid white;
    }
    
    .drop-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .drop-zone.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        border-color: #94a3b8;
    }
    
    .drop-zone:hover:not(.disabled), .drop-zone.dragover:not(.disabled) {
        border-color: #667eea;
        background-color: #f7fafc;
    }
    
    .upload-disabled-message {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        max-width: 80%;
    }
    
    .typing-dots {
        display: flex;
        margin-left: 0.5rem;
    }
    
    .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #94a3b8;
        margin: 0 1px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .markdown-content h1 { font-size: 1.5rem; }
    .markdown-content h2 { font-size: 1.25rem; }
    .markdown-content h3 { font-size: 1.125rem; }
    
    .markdown-content ul, .markdown-content ol {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .markdown-content li {
        margin-bottom: 0.25rem;
    }
    
    .markdown-content strong {
        font-weight: 600;
    }
    
    .markdown-content em {
        font-style: italic;
    }
    
    .markdown-content code {
        background-color: #f1f5f9;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: monospace;
        font-size: 0.875rem;
    }
    
    .markdown-content pre {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #cbd5e0;
        padding-left: 1rem;
        margin-left: 0;
        color: #64748b;
        font-style: italic;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="sidebar rounded-lg shadow-lg p-4">
                <!-- Encabezado de sesión -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-2">Sesión Actual</h2>
                    <div class="bg-white text-indigo-800 rounded-lg p-3">
                        <p class="text-sm font-medium truncate" id="session-id">Cargando...</p>
                        <button id="new-session-btn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-1 px-3 rounded transition-all">
                            <i class="fas fa-plus mr-1"></i> Nueva Sesión
                        </button>
                    </div>
                </div>
                
                <!-- Tabs para archivos y conversaciones -->
                <div class="mb-4">
                    <div class="flex border-b border-white border-opacity-20">
                        <button id="files-tab" class="flex-1 py-2 text-center font-medium text-white text-opacity-70">Archivos</button>
                        <button id="conversations-tab" class="flex-1 py-2 text-center font-medium border-white">Conversaciones</button>
                    </div>
                </div>
                
                <!-- Contenido de pestaña Archivos -->
                <div id="files-content">
                    <!-- Área de subida de archivos - Solo habilitada con conversación activa -->
                    <div class="mb-4">
                        <div id="upload-disabled-message" class="upload-disabled-message hidden">
                            <i class="fas fa-comments text-2xl mb-2"></i>
                            <p class="text-sm">Selecciona o crea una conversación para subir archivos</p>
                        </div>
                        
                        <div id="drop-zone" class="drop-zone disabled">
                            <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-white text-opacity-80"></i>
                            <p class="text-white text-opacity-80">Selecciona una conversación para subir archivos</p>
                            <input type="file" id="file-input" class="hidden" multiple disabled>
                            <button id="upload-btn" class="mt-2 bg-white text-indigo-700 py-1 px-3 rounded text-sm font-medium hover:bg-opacity-90 transition-all" disabled>
                                Seleccionar Archivos
                            </button>
                        </div>
                        <div id="upload-progress" class="mt-2 hidden">
                            <div class="flex justify-between text-sm text-white text-opacity-80 mb-1">
                                <span>Procesando...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-20 rounded-full h-2">
                                <div id="progress-bar" class="bg-white h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de archivos de la conversación actual -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium">Archivos de esta conversación</h3>
                            <span id="files-count" class="bg-white bg-opacity-20 text-xs rounded-full px-2 py-1">0</span>
                        </div>
                        <div id="files-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>No hay archivos en esta conversación</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de pestaña Conversaciones -->
                <div id="conversations-content" class="hidden">
                    <!-- Botón para nueva conversación -->
                    <div class="mb-4">
                        <button id="new-conversation-btn" class="w-full bg-white text-indigo-700 py-2 px-3 rounded font-medium hover:bg-opacity-90 transition-all">
                            <i class="fas fa-plus mr-2"></i> Nueva Conversación
                        </button>
                    </div>
                    
                    <!-- Lista de conversaciones -->
                    <div>
                        <h3 class="font-medium mb-2">Tus Conversaciones</h3>
                        <div id="conversations-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                            <div class="empty-state">
                                <i class="fas fa-comments"></i>
                                <p>No hay conversaciones</p>
                                <p class="text-sm mt-2">Crea tu primera conversación</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Área principal de chat -->
        <div class="lg:col-span-3">
            <div class="chat-container bg-white rounded-lg shadow-lg">
                <!-- Encabezado del chat -->
                <div class="border-b border-gray-200 p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 id="conversation-title" class="text-xl font-bold text-gray-800">Selecciona una Conversación</h2>
                            <p id="conversation-info" class="text-sm text-gray-500">Crea o selecciona una conversación para comenzar</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="clear-chat-btn" class="text-gray-500 hover:text-gray-700 transition-colors hidden" title="Limpiar chat">
                                <i class="fas fa-broom"></i>
                            </button>
                            <button id="delete-conversation-btn" class="text-red-500 hover:text-red-700 transition-colors hidden" title="Eliminar conversación">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Área de mensajes -->
                <div id="messages-container" class="messages-container custom-scrollbar">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-comments text-4xl mb-2 text-gray-300"></i>
                        <p class="text-lg font-medium text-gray-600">Bienvenido a DS Salud IA</p>
                        <p class="text-gray-500 mt-2">Crea una conversación para comenzar a chatear con tus documentos</p>
                        <button id="quick-create-conversation" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-plus mr-2"></i> Crear Primera Conversación
                        </button>
                    </div>
                </div>
                
                <!-- Área de entrada - Solo habilitada con conversación activa -->
                <div class="border-t border-gray-200 p-4">
                    <form id="chat-form" class="flex space-x-2">
                        <div class="flex-1">
                            <input 
                                type="text" 
                                id="question-input" 
                                placeholder="Selecciona una conversación para comenzar..." 
                                class="w-full border border-gray-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                autocomplete="off"
                                disabled
                            >
                        </div>
                        <button 
                            type="submit" 
                            id="send-btn"
                            class="bg-gray-400 text-white py-3 px-6 rounded-lg transition-all cursor-not-allowed"
                            disabled
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para nueva conversación -->
<div id="new-conversation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Nueva Conversación</h3>
        <form id="new-conversation-form">
            <div class="mb-4">
                <label for="conversation-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la conversación</label>
                <input 
                    type="text" 
                    id="conversation-name" 
                    class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Mi conversación"
                    value="Nueva Conversación"
                >
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancel-conversation-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all">
                    Crear
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Estado de la aplicación
    let appState = {
        sessionId: null,
        currentConversationId: null,
        currentConversation: null,
        conversations: [],
        files: [],
        isProcessing: false
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        switchTab('conversations')
        initializeApp();
        setupEventListeners();
    });

    // Inicializar la aplicación
    function initializeApp() {
        // Generar o recuperar sessionId
        const savedSessionId = localStorage.getItem('notebooklm_session_id');
        if (savedSessionId) {
            appState.sessionId = savedSessionId;
        } else {
            appState.sessionId = generateSessionId();
            localStorage.setItem('notebooklm_session_id', appState.sessionId);
        }
        
        document.getElementById('session-id').textContent = appState.sessionId;
        
        // Cargar conversaciones
        loadConversations();
        
        // Estado inicial: sin conversación activa
        updateUIForNoConversation();
    }

    // Configurar event listeners
    function setupEventListeners() {
        // Tabs de sidebar
        document.getElementById('files-tab').addEventListener('click', () => switchTab('files'));
        document.getElementById('conversations-tab').addEventListener('click', () => switchTab('conversations'));
        
        // Subida de archivos
        document.getElementById('upload-btn').addEventListener('click', () => {
            if (!appState.currentConversationId) return;
            document.getElementById('file-input').click();
        });
        document.getElementById('file-input').addEventListener('change', handleFileSelect);
        setupDragAndDrop();
        
        // Conversaciones
        document.getElementById('new-conversation-btn').addEventListener('click', showNewConversationModal);
        document.getElementById('quick-create-conversation').addEventListener('click', showNewConversationModal);
        document.getElementById('new-conversation-form').addEventListener('submit', createNewConversation);
        document.getElementById('cancel-conversation-btn').addEventListener('click', hideNewConversationModal);
        
        // Chat
        document.getElementById('chat-form').addEventListener('submit', sendMessage);
        document.getElementById('clear-chat-btn').addEventListener('click', clearChat);
        document.getElementById('delete-conversation-btn').addEventListener('click', deleteCurrentConversation);
        
        // Nueva sesión
        document.getElementById('new-session-btn').addEventListener('click', createNewSession);
        
        // Tecla Enter para enviar mensaje
        document.getElementById('question-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !this.disabled) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });
    }

    // Funciones de utilidad
    function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function switchTab(tabName) {
        const filesTab = document.getElementById('files-tab');
        const conversationsTab = document.getElementById('conversations-tab');
        const filesContent = document.getElementById('files-content');
        const conversationsContent = document.getElementById('conversations-content');

        filesTab.classList.remove('border-b-2');
        conversationsTab.classList.remove('border-b-2');
        
        if (tabName === 'files') {
            filesTab.classList.add('border-b-2');

            filesTab.classList.add('border-white');
            filesTab.classList.remove('text-opacity-70');
            conversationsTab.classList.remove('border-white');
            conversationsTab.classList.add('text-opacity-70');
            filesContent.classList.remove('hidden');
            conversationsContent.classList.add('hidden');
        } else {
            conversationsTab.classList.add('border-b-2');

            conversationsTab.classList.add('border-white');
            conversationsTab.classList.remove('text-opacity-70');
            filesTab.classList.remove('border-white');
            filesTab.classList.add('text-opacity-70');
            conversationsContent.classList.remove('hidden');
            filesContent.classList.add('hidden');
        }
    }

    // Funciones para manejar el estado de la UI
    function updateUIForNoConversation() {
        // Deshabilitar subida de archivos
        document.getElementById('drop-zone').classList.add('disabled');
        document.getElementById('upload-btn').disabled = true;
        document.getElementById('file-input').disabled = true;
        document.getElementById('upload-disabled-message').classList.remove('hidden');
        
        // Deshabilitar chat
        document.getElementById('question-input').disabled = true;
        document.getElementById('question-input').placeholder = "Selecciona una conversación para comenzar...";
        document.getElementById('send-btn').disabled = true;
        document.getElementById('send-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        document.getElementById('send-btn').classList.add('bg-gray-400', 'cursor-not-allowed');
        
        // Ocultar botones de conversación
        document.getElementById('clear-chat-btn').classList.add('hidden');
        document.getElementById('delete-conversation-btn').classList.add('hidden');
        
        // Actualizar encabezado
        document.getElementById('conversation-title').textContent = "Selecciona una Conversación";
        document.getElementById('conversation-info').textContent = "Crea o selecciona una conversación para comenzar";
        
        // Mostrar estado vacío en archivos
        document.getElementById('files-count').textContent = "0";
    }

    function updateUIForActiveConversation() {
        // Habilitar subida de archivos
        document.getElementById('drop-zone').classList.remove('disabled');
        document.getElementById('upload-btn').disabled = false;
        document.getElementById('file-input').disabled = false;
        document.getElementById('upload-disabled-message').classList.add('hidden');
        
        // Habilitar chat
        document.getElementById('question-input').disabled = false;
        document.getElementById('question-input').placeholder = "Escribe tu pregunta...";
        document.getElementById('send-btn').disabled = false;
        document.getElementById('send-btn').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        document.getElementById('send-btn').classList.remove('bg-gray-400', 'cursor-not-allowed');
        
        // Mostrar botones de conversación
        document.getElementById('clear-chat-btn').classList.remove('hidden');
        document.getElementById('delete-conversation-btn').classList.remove('hidden');
    }

    // Funciones de archivos
    function setupDragAndDrop() {
        const dropZone = document.getElementById('drop-zone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                if (!dropZone.classList.contains('disabled')) {
                    dropZone.classList.add('dragover');
                }
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('dragover');
            }, false);
        });
        
        dropZone.addEventListener('drop', handleDrop, false);
    }

    function handleDrop(e) {
        if (!appState.currentConversationId) return;
        
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFileSelect(e) {
        if (!appState.currentConversationId) return;
        
        const files = e.target.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        if (files.length === 0 || !appState.currentConversationId) return;
        
        const progressContainer = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        
        progressContainer.classList.remove('hidden');
        
        // Simular progreso
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${progress}%`;
            progressPercent.textContent = `${progress}%`;
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0%';
                }, 500);
            }
        }, 100);
        
        // Subir archivos
        Array.from(files).forEach(file => {
            uploadFile(file);
        });
    }

    async function uploadFile(file) {
        if (!appState.currentConversationId) {
            alert('Debes tener una conversación activa para subir archivos');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('session_id', appState.sessionId);
        formData.append('conversation_id', appState.currentConversationId);
        
        try {
            const response = await fetch('/api/v1/upload', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Archivo subido:', result);
                // Recargar la conversación actual para actualizar la lista de archivos
                if (appState.currentConversationId) {
                    switchToConversation(appState.currentConversationId);
                }
            } else {
                console.error('Error al subir archivo:', response.statusText);
                alert('Error al subir el archivo');
            }
        } catch (error) {
            console.error('Error al subir archivo:', error);
            alert('Error al subir el archivo');
        }
    }

    function renderFilesList() {
        const filesList = document.getElementById('files-list');
        const filesCount = document.getElementById('files-count');
        
        if (!appState.currentConversation || !appState.currentConversation.files || appState.currentConversation.files.length === 0) {
            filesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>No hay archivos en esta conversación</p>
                </div>
            `;
            filesCount.textContent = "0";
            return;
        }
        
        filesCount.textContent = appState.currentConversation.files.length;
        
        filesList.innerHTML = appState.currentConversation.files.map(file => `
            <div class="file-card">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-medium truncate">${file.original_filename}</h4>
                        <p class="text-xs text-white text-opacity-70 mt-1">
                            ${formatFileSize(file.size)} • ${formatDate(file.created_at)}
                        </p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Funciones de conversaciones
    function showNewConversationModal() {
        document.getElementById('new-conversation-modal').classList.remove('hidden');
    }

    function hideNewConversationModal() {
        document.getElementById('new-conversation-modal').classList.add('hidden');
    }

    async function createNewConversation(e) {
        e.preventDefault();
        
        const name = document.getElementById('conversation-name').value || 'Nueva Conversación';
        
        try {
            const response = await fetch('/api/v1/conversations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: appState.sessionId,
                    name: name
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                hideNewConversationModal();
                loadConversations();
                switchToConversation(result.conversation_id);
            } else {
                console.error('Error al crear conversación:', response.statusText);
                alert('Error al crear la conversación');
            }
        } catch (error) {
            console.error('Error al crear conversación:', error);
            alert('Error al crear la conversación');
        }
    }

    async function loadConversations() {
        try {
            const response = await fetch(`/api/v1/conversations/${appState.sessionId}`);
            
            if (response.ok) {
                const result = await response.json();
                appState.conversations = result.conversations || [];
                renderConversationsList();
            } else {
                console.error('Error al cargar conversaciones:', response.statusText);
            }
        } catch (error) {
            console.error('Error al cargar conversaciones:', error);
        }
    }

    function renderConversationsList() {
        const conversationsList = document.getElementById('conversations-list');
        
        if (appState.conversations.length === 0) {
            conversationsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p>No hay conversaciones</p>
                    <p class="text-sm mt-2">Crea tu primera conversación</p>
                </div>
            `;
            return;
        }
        
        conversationsList.innerHTML = appState.conversations.map(conv => `
            <div class="conversation-item ${conv.id === appState.currentConversationId ? 'active' : ''}" 
                 data-conversation-id="${conv.id}">
                <h4 class="font-medium truncate">${conv.name}</h4>
                <p class="text-xs text-white text-opacity-70 mt-1">
                    ${formatDate(conv.updated_at)} • ${conv.message_count || 0} mensajes
                </p>
            </div>
        `).join('');
        
        // Añadir event listeners a los elementos de conversación
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', function() {
                const conversationId = parseInt(this.getAttribute('data-conversation-id'));
                switchToConversation(conversationId);
            });
        });
    }

    async function switchToConversation(conversationId) {
        try {
            const response = await fetch(`/api/v1/conversation/${conversationId}`);
            
            if (response.ok) {
                const conversation = await response.json();
                appState.currentConversationId = conversationId;
                appState.currentConversation = conversation;
                
                // Actualizar UI
                updateUIForActiveConversation();
                document.getElementById('conversation-title').textContent = conversation.name;
                document.getElementById('conversation-info').textContent = 
                    `${conversation.files.length} archivos • ${conversation.messages.length} mensajes`;
                
                // Renderizar mensajes
                renderMessages(conversation.messages);
                
                // Renderizar archivos
                renderFilesList();
                
                // Actualizar lista de conversaciones
                renderConversationsList();
                
                console.log('Conversación cargada:', conversation);
            } else {
                console.error('Error al cargar conversación:', response.statusText);
            }
        } catch (error) {
            console.error('Error al cargar conversación:', error);
        }
    }

    function renderMessages(messages) {
        const messagesContainer = document.getElementById('messages-container');
        
        if (!messages || messages.length === 0) {
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-comments text-4xl mb-2 text-gray-300"></i>
                    <p>Comienza una conversación preguntando sobre tus documentos</p>
                </div>
            `;
            return;
        }
        
        messagesContainer.innerHTML = messages.map(msg => `
            <div class="message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}">
                <div class="message-header">
                    ${msg.role === 'user' ? 'Tú' : 'DS Salud IA'}
                </div>
                <div class="markdown-content">
                    ${convertMarkdownToHTML(msg.content)}
                </div>
                ${msg.metadata ? `
                <div class="mt-2 text-xs text-gray-500">
                    ${msg.metadata.chunks_utilizados ? `Chunks: ${msg.metadata.chunks_utilizados} | ` : ''}
                    ${msg.metadata.distancia_promedio ? `Distancia: ${msg.metadata.distancia_promedio.toFixed(3)}` : ''}
                </div>
                ` : ''}
            </div>
        `).join('');
        
        // Scroll al final
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function deleteCurrentConversation() {
        if (!appState.currentConversationId) {
            alert('No hay conversación activa para eliminar');
            return;
        }
        
        if (!confirm('¿Estás seguro de que quieres eliminar esta conversación? Se eliminarán todos los mensajes y archivos asociados.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/v1/conversations/${appState.currentConversationId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                appState.currentConversationId = null;
                appState.currentConversation = null;
                updateUIForNoConversation();
                renderMessages([]);
                renderFilesList();
                loadConversations();
            } else {
                console.error('Error al eliminar conversación:', response.statusText);
                alert('Error al eliminar la conversación');
            }
        } catch (error) {
            console.error('Error al eliminar conversación:', error);
            alert('Error al eliminar la conversación');
        }
    }

    // Funciones de chat
    async function sendMessage(e) {
        e.preventDefault();
        
        if (appState.isProcessing || !appState.currentConversationId) return;
        
        const questionInput = document.getElementById('question-input');
        const question = questionInput.value.trim();
        
        if (!question) return;
        
        // Limpiar input
        questionInput.value = '';
        
        // Mostrar mensaje del usuario
        const messagesContainer = document.getElementById('messages-container');
        
        // Si es el primer mensaje, limpiar el placeholder
        if (messagesContainer.querySelector('.text-center')) {
            messagesContainer.innerHTML = '';
        }
        
        // Añadir mensaje del usuario
        const userMessageHtml = `
            <div class="message user-message">
                <div class="message-header">Tú</div>
                <div>${escapeHtml(question)}</div>
            </div>
        `;
        messagesContainer.innerHTML += userMessageHtml;
        
        // Mostrar indicador de escritura
        const typingIndicator = `
            <div class="typing-indicator">
                <span>Asistente está escribiendo</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        messagesContainer.innerHTML += typingIndicator;
        
        // Scroll al final
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Enviar pregunta al servidor
        appState.isProcessing = true;
        
        try {
            const response = await fetch('/api/v1/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: appState.sessionId,
                    conversation_id: appState.currentConversationId,
                    question: question,
                    score_threshold: 0.5,
                    use_history: true
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Remover indicador de escritura
                const typingIndicator = messagesContainer.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }

                // Añadir respuesta del asistente
                const assistantMessageHtml = `
                    <div class="message assistant-message">
                        <div class="message-header">DS Salud IA</div>
                        <div class="markdown-content">${convertMarkdownToHTML(result.respuesta)}</div>
                        <div class="mt-2 text-xs text-gray-500">
                            Chunks: ${result.chunks_utilizados} | Distancia: ${result.distancia.toFixed(3)}
                        </div>
                    </div>
                `;
                messagesContainer.innerHTML += assistantMessageHtml;
                
                // Recargar la conversación para actualizar el historial
                switchToConversation(appState.currentConversationId);
                
                // Scroll al final
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            console.error('Error al enviar mensaje:', error);
            
            // Remover indicador de escritura
            const typingIndicator = messagesContainer.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            // Mostrar mensaje de error
            const errorMessageHtml = `
                <div class="message assistant-message">
                    <div class="message-header">Error</div>
                    <div>Lo siento, ha ocurrido un error al procesar tu pregunta. Por favor, inténtalo de nuevo.</div>
                </div>
            `;
            messagesContainer.innerHTML += errorMessageHtml;
            
            // Scroll al final
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } finally {
            appState.isProcessing = false;
        }
    }

    function clearChat() {
        if (!appState.currentConversationId) {
            return;
        }
        
        if (!confirm('¿Estás seguro de que quieres limpiar el historial de esta conversación?')) {
            return;
        }
        
        fetch(`/api/v1/conversations/${appState.currentConversationId}/messages`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                renderMessages([]);
                // Recargar la conversación para actualizar el estado
                switchToConversation(appState.currentConversationId);
            } else {
                console.error('Error al limpiar mensajes:', response.statusText);
                alert('Error al limpiar el historial');
            }
        })
        .catch(error => {
            console.error('Error al limpiar mensajes:', error);
            alert('Error al limpiar el historial');
        });
    }

    function createNewSession() {
        if (confirm('¿Estás seguro de que quieres crear una nueva sesión? Se perderán todas las conversaciones y archivos actuales.')) {
            appState.sessionId = generateSessionId();
            localStorage.setItem('notebooklm_session_id', appState.sessionId);
            appState.currentConversationId = null;
            appState.currentConversation = null;
            appState.conversations = [];
            appState.files = [];
            
            document.getElementById('session-id').textContent = appState.sessionId;
            updateUIForNoConversation();
            renderMessages([]);
            renderFilesList();
            renderConversationsList();
        }
    }

    // Funciones de utilidad
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function convertMarkdownToHTML(markdown) {
        if (!markdown) return '';

        return markdown
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/gim, '<em>$1</em>')
            .replace(/`(.*?)`/gim, '<code>$1</code>')
            .replace(/^\* (.*$)/gim, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            .replace(/^\d\. (.*$)/gim, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>')
            .replace(/\n/g, '<br>')
            .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
            .replace(/(<br>){3,}/g, '<br><br>');
    }
</script>
{% endblock %}